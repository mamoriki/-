<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แอปนับเลข ออนไลน์</title>
    <!-- ใช้งาน Tailwind CSS เพื่อความสวยงาม -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'IBM Plex Sans Thai', sans-serif;
        }
        .btn {
            @apply px-4 py-2 rounded-lg font-bold text-white shadow-md transition-all duration-200 ease-in-out;
        }
        .btn:hover {
            @apply shadow-lg -translate-y-0.5;
        }
        .btn:active {
            @apply shadow-sm translate-y-0;
        }
        .notes-log::-webkit-scrollbar { width: 8px; }
        .notes-log::-webkit-scrollbar-track { background: #f1f1f1; }
        .dark .notes-log::-webkit-scrollbar-track { background: #374151; }
        .notes-log::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        .notes-log::-webkit-scrollbar-thumb:hover { background: #555; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; margin: 0; 
        }
        input[type=number] { -moz-appearance: textfield; }
        .text-custom-blue { color: #4691D3; }
        .bg-custom-blue { background-color: #4691D3; }
        .hover\:bg-custom-blue-dark:hover { background-color: #3a7bb5; }
        .text-custom-red { color: #BE2623; }
        /* สไตล์สำหรับโหมดแก้ไขประวัติ */
        .notes-log.edit-mode .log-entry {
            @apply cursor-pointer border-blue-500 ring-2 ring-blue-300;
        }
        .notes-panel.edit-mode-bg {
            background-color: #333845 !important;
        }
        .notes-panel.edit-mode-bg h2 {
            color: white !important;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Main App Wrapper -->
    <div id="app-wrapper" class="min-h-screen flex flex-col">
        <!-- Top Navigation Bar -->
        <header class="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-10">
            <div id="welcome-message" class="font-semibold text-gray-700 text-sm sm:text-base truncate"></div>
            <div class="flex items-center gap-2 sm:gap-4">
                <button id="show-delete-btn" class="btn bg-red-500 hover:bg-red-600 hidden px-5 py-2.5">
                    <span class="hidden sm:inline">- ลบ</span>
                    <span class="sm:hidden">-</span>
                </button>
                <button id="add-counter-btn" class="btn bg-green-500 hover:bg-green-600 px-5 py-2.5">
                    <span class="hidden sm:inline">+ เพิ่ม</span>
                    <span class="sm:hidden">+</span>
                </button>
                 <button id="calculator-btn" class="p-2 rounded-full text-gray-500 hover:bg-gray-100">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
                </button>
                <button id="show-login-btn" class="font-semibold text-custom-blue hover:text-blue-800 transition-colors text-sm px-2 py-1">เข้าสู่ระบบ</button>
                <button id="logout-btn" class="font-semibold text-gray-500 hover:text-gray-800 transition-colors text-sm px-2 py-1 hidden">ออกจากระบบ</button>
            </div>
        </header>

        <!-- Container for all counter instances -->
        <main id="counters-wrapper" class="p-4 space-y-6 flex-grow">
            <!-- Counter instances will be injected here by JS -->
        </main>
    </div>

    <!-- Modals -->
    <div id="login-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="w-full max-w-md mx-auto bg-white rounded-2xl shadow-xl p-6 md:p-8 space-y-6 relative">
            <button id="close-login-modal-btn" class="absolute top-3 right-3 p-1 text-gray-400 hover:text-red-500 text-2xl leading-none">&times;</button>
            <h1 class="text-2xl font-bold text-center text-gray-800">เข้าสู่ระบบ</h1>
            <div class="space-y-4">
                <input type="text" id="id-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="ไอดีผู้ใช้" autocomplete="off">
                <div class="relative">
                    <input type="password" id="password-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg pr-10" placeholder="รหัสผ่าน" autocomplete="off">
                    <button id="toggle-password-btn" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500">
                        <svg id="eye-open-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.012 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>
                        <svg id="eye-closed-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.707 2.293a1 1 0 00-1.414 1.414l14 14a1 1 0 001.414-1.414l-1.473-1.473A10.014 10.014 0 0019.542 10C18.268 5.943 14.478 3 10 3a9.958 9.958 0 00-4.512 1.074l-1.78-1.781zm4.261 4.26l1.514 1.515a2 2 0 012.828 2.828l1.515 1.515A4 4 0 0014 10a4 4 0 10-5.738-2.45zM1.058 10a10.027 10.027 0 013.37-4.47l1.425 1.425A8.013 8.013 0 004.458 10c1.274 4.057 5.012 7 9.542 7a8.013 8.013 0 004.47-1.058l1.425 1.425A10.027 10.027 0 011.058 10z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
            </div>
            <div class="pt-2">
                <button id="login-btn" class="w-full btn bg-blue-500 hover:bg-blue-600">ยืนยัน</button>
            </div>
            <p id="auth-status" class="text-center text-red-500 h-4"></p>
        </div>
    </div>

    <div id="set-value-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
            <h3 id="set-value-title" class="text-lg font-bold mb-4">แก้ไขยอด</h3>
            <input type="number" id="set-value-input-modal" class="w-full p-2 border border-gray-300 rounded-lg text-xl" placeholder="ใส่ตัวเลขใหม่">
            <div class="mt-4 flex justify-end gap-3">
                <button id="set-value-cancel-btn" class="btn bg-gray-400">ยกเลิก</button>
                <button id="set-value-confirm-btn" class="btn bg-custom-blue hover:bg-custom-blue-dark">บันทึก</button>
            </div>
        </div>
    </div>
    
    <div id="edit-note-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
            <h3 class="text-lg font-bold mb-4">แก้ไขโน้ต</h3>
            <textarea id="edit-note-input" class="w-full p-2 border border-gray-300 rounded-lg" rows="4"></textarea>
            <div class="mt-4 flex justify-end gap-3">
                <button id="edit-note-cancel-btn" class="btn bg-gray-400">ยกเลิก</button>
                <button id="edit-note-confirm-btn" class="btn bg-custom-blue hover:bg-custom-blue-dark">บันทึก</button>
            </div>
        </div>
    </div>

    <div id="delete-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
            <h3 class="text-lg font-bold mb-4">เลือกลบรายการ</h3>
            <div class="space-y-2 max-h-60 overflow-y-auto" id="delete-list-container">
                <!-- Checkboxes will be inserted here -->
            </div>
            <div class="mt-4 border-t pt-4">
                <label class="flex items-center"><input type="checkbox" id="select-all-delete" class="mr-2"> เลือกทั้งหมด</label>
            </div>
            <div class="mt-4 flex justify-end gap-3">
                <button id="delete-cancel-btn" class="btn bg-gray-400">ยกเลิก</button>
                <button id="delete-confirm-btn" class="btn bg-red-500">ลบที่เลือก</button>
            </div>
        </div>
    </div>

    <div id="calculator-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="w-full max-w-xs mx-auto bg-white rounded-2xl shadow-xl p-4 space-y-4">
            <div class="bg-gray-200 text-right rounded-lg p-4 text-gray-800 break-all">
                <div id="calc-history" class="text-sm text-gray-500 h-6">&nbsp;</div>
                <div id="calc-display" class="text-3xl">0</div>
            </div>
            <div id="calc-keys" class="grid grid-cols-4 gap-2">
                <button class="calc-btn bg-gray-300 p-4 rounded-lg text-xl">AC</button>
                <button class="calc-btn bg-gray-300 p-4 rounded-lg text-xl">+/-</button>
                <button class="calc-btn bg-gray-300 p-4 rounded-lg text-xl">%</button>
                <button class="calc-btn bg-yellow-500 p-4 rounded-lg text-xl text-white">÷</button>
                <button class="calc-btn bg-gray-500 p-4 rounded-lg text-xl text-white">7</button>
                <button class="calc-btn bg-gray-500 p-4 rounded-lg text-xl text-white">8</button>
                <button class="calc-btn bg-gray-500 p-4 rounded-lg text-xl text-white">9</button>
                <button class="calc-btn bg-yellow-500 p-4 rounded-lg text-xl text-white">×</button>
                <button class="calc-btn bg-gray-500 p-4 rounded-lg text-xl text-white">4</button>
                <button class="calc-btn bg-gray-500 p-4 rounded-lg text-xl text-white">5</button>
                <button class="calc-btn bg-gray-500 p-4 rounded-lg text-xl text-white">6</button>
                <button class="calc-btn bg-yellow-500 p-4 rounded-lg text-xl text-white">-</button>
                <button class="calc-btn bg-gray-500 p-4 rounded-lg text-xl text-white">1</button>
                <button class="calc-btn bg-gray-500 p-4 rounded-lg text-xl text-white">2</button>
                <button class="calc-btn bg-gray-500 p-4 rounded-lg text-xl text-white">3</button>
                <button class="calc-btn bg-yellow-500 p-4 rounded-lg text-xl text-white">+</button>
                <button class="calc-btn bg-gray-500 p-4 rounded-lg text-xl text-white col-span-2">0</button>
                <button class="calc-btn bg-gray-500 p-4 rounded-lg text-xl text-white">.</button>
                <button class="calc-btn bg-yellow-500 p-4 rounded-lg text-xl text-white">=</button>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-lg text-center">
            <p id="confirm-text" class="text-lg">คุณแน่ใจหรือไม่?</p>
            <div class="mt-6 flex justify-center gap-4">
                <button id="confirm-cancel-btn" class="btn bg-gray-400">ยกเลิก</button>
                <button id="confirm-ok-btn" class="btn bg-red-500">ยืนยัน</button>
            </div>
        </div>
    </div>

    <!-- Template for a single counter instance -->
    <template id="counter-template">
        <div class="counter-instance w-full max-w-6xl mx-auto flex flex-col md:flex-row gap-6 items-start">
            <!-- Counter UI -->
            <div class="counter-ui-panel w-full md:w-2/5 bg-white rounded-2xl shadow-xl p-6 text-center flex flex-col space-y-4 relative">
                <button class="delete-btn hidden absolute top-3 right-3 p-1 text-gray-400 hover:text-red-500 rounded-full hover:bg-red-100">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
                <div class="flex items-center justify-center gap-2">
                    <h1 class="counter-title text-3xl font-bold text-gray-800"></h1>
                    <button class="edit-title-btn p-1 text-gray-400 hover:text-blue-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
                <div class="my-2">
                    <p class="count-display text-8xl font-bold text-blue-600">0</p>
                </div>
                <div class="flex items-stretch justify-center gap-2">
                    <button class="decrement-btn btn bg-red-500 text-4xl flex-1">-</button>
                    <div class="flex items-center border border-gray-300 rounded-lg">
                        <button class="lock-step-btn p-2 text-gray-400 hover:bg-gray-100 h-full text-2xl rounded-l-md">
                            <span class="unlocked-icon">🔓</span>
                            <span class="locked-icon hidden">🔒</span>
                        </button>
                        <input type="number" class="step-input w-20 text-center text-2xl bg-transparent focus:outline-none h-full border-l border-r border-gray-300 text-gray-900" value="1" min="1">
                        <div class="flex flex-col h-full border-l border-gray-300">
                            <button class="step-up-btn flex-1 px-2 text-gray-500 hover:bg-gray-100 border-b border-gray-300 rounded-tr-sm">▲</button>
                            <button class="step-down-btn flex-1 px-2 text-gray-500 hover:bg-gray-100 rounded-br-sm">▼</button>
                        </div>
                    </div>
                    <button class="increment-btn btn bg-green-500 text-4xl flex-1">+</button>
                </div>
                <div>
                    <textarea class="action-note-input w-full p-2 border border-gray-300 rounded-lg" rows="2" placeholder="เพิ่มโน้ต (ไม่บังคับ)"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <button class="reset-btn btn bg-yellow-500 font-bold">รีเซ็ต</button>
                    <button class="edit-value-btn btn bg-custom-blue hover:bg-custom-blue-dark font-bold">แก้ไขยอด</button>
                </div>
            </div>
            <!-- Notes UI -->
            <div class="notes-panel w-full md:w-3/5 bg-white rounded-2xl shadow-xl p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">ประวัติ</h2>
                    <div>
                        <button class="edit-notes-btn text-sm font-semibold text-custom-blue hover:text-blue-800">แก้ไข</button>
                        <button class="done-editing-notes-btn text-sm font-semibold text-green-500 hover:text-green-700 hidden">เสร็จสิ้น</button>
                    </div>
                </div>
                <div class="notes-log h-96 md:max-h-[calc(100vh-15rem)] overflow-y-auto space-y-3 pr-2"></div>
            </div>
        </div>
    </template>


    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const fbApp = initializeApp(firebaseConfig);
        const auth = getAuth(fbApp);
        const db = getFirestore(fbApp);

        const testUsers = [
            { id: 'preembee', pass: '455456', firestoreId: 'preembee-test-user-v1' },
            { id: 'test', pass: '123456', firestoreId: 'test-user-v2' },
            { id: 'a', pass: 'a', firestoreId: 'a-test-user-v1' },
            { id: '1', pass: '1', firestoreId: '1-test-user-v1' }
        ];

        const countersWrapper = document.getElementById('counters-wrapper');
        const counterTemplate = document.getElementById('counter-template');
        const addCounterBtn = document.getElementById('add-counter-btn');
        const welcomeMessage = document.getElementById('welcome-message');
        
        const loginModal = document.getElementById('login-modal');
        const showLoginBtn = document.getElementById('show-login-btn');
        const closeLoginModalBtn = document.getElementById('close-login-modal-btn');
        const idInput = document.getElementById('id-input');
        const passwordInput = document.getElementById('password-input');
        const loginBtn = document.getElementById('login-btn');
        const authStatus = document.getElementById('auth-status');
        const logoutBtn = document.getElementById('logout-btn');
        const togglePasswordBtn = document.getElementById('toggle-password-btn');

        const setValueModal = document.getElementById('set-value-modal');
        const setValueTitle = document.getElementById('set-value-title');
        const setValueInputModal = document.getElementById('set-value-input-modal');
        const setValueConfirmBtn = document.getElementById('set-value-confirm-btn');
        const setValueCancelBtn = document.getElementById('set-value-cancel-btn');
        
        const editNoteModal = document.getElementById('edit-note-modal');
        const editNoteInput = document.getElementById('edit-note-input');
        const editNoteConfirmBtn = document.getElementById('edit-note-confirm-btn');
        const editNoteCancelBtn = document.getElementById('edit-note-cancel-btn');

        const deleteModal = document.getElementById('delete-modal');
        const showDeleteBtn = document.getElementById('show-delete-btn');
        const deleteListContainer = document.getElementById('delete-list-container');
        const selectAllDelete = document.getElementById('select-all-delete');
        const deleteConfirmBtn = document.getElementById('delete-confirm-btn');
        const deleteCancelBtn = document.getElementById('delete-cancel-btn');

        const calculatorModal = document.getElementById('calculator-modal');
        const calculatorBtn = document.getElementById('calculator-btn');
        const calcDisplay = document.getElementById('calc-display');
        const calcHistory = document.getElementById('calc-history');
        const calcKeys = document.getElementById('calc-keys');

        const confirmModal = document.getElementById('confirm-modal');
        const confirmText = document.getElementById('confirm-text');
        const confirmOkBtn = document.getElementById('confirm-ok-btn');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
        
        let allCountersData = [];
        let userDocRef = null;
        let unsubscribe = null; 
        let currentUser = null; 
        let setValueResolve = null;
        let lastInteractedCounterId = null;
        let editNoteResolve = null;
        
        // ฟังก์ชันสำหรับบันทึกข้อมูล
        async function saveData(newCountersArray) {
            allCountersData = newCountersArray; // อัปเดตข้อมูลในหน่วยความจำก่อน
            if (currentUser && currentUser.id !== 'ผู้ใช้ไม่ระบุตัวตน') {
                // สำหรับผู้ใช้ที่ล็อกอิน: บันทึกไปที่ Firestore
                if (!userDocRef) return;
                try {
                    const dataToSave = newCountersArray.map(counter => {
                        const { isEditingNotes, ...rest } = counter;
                        return rest;
                    });
                    await setDoc(userDocRef, { counters: dataToSave });
                } catch (error) {
                    console.error("Error saving data to Firestore: ", error);
                }
            } else {
                // สำหรับผู้ใช้ทั่วไป: บันทึกไปที่ localStorage
                localStorage.setItem('anonymousCounters', JSON.stringify(newCountersArray));
                // และ re-render ทันทีเนื่องจากไม่มี onSnapshot
                renderAllCounters(newCountersArray);
            }
        }

        function askForConfirmation(text) {
            return new Promise(resolve => {
                confirmText.textContent = text;
                confirmModal.classList.remove('hidden');
                confirmOkBtn.onclick = () => { confirmModal.classList.add('hidden'); resolve(true); };
                confirmCancelBtn.onclick = () => { confirmModal.classList.add('hidden'); resolve(false); };
            });
        }
        
        function askForValue(title) {
             return new Promise(resolve => {
                setValueResolve = resolve;
                setValueTitle.textContent = `แก้ไขยอด: ${title}`;
                setValueInputModal.value = '';
                setValueModal.classList.remove('hidden');
                setValueInputModal.focus();
            });
        }
        
        function askToEditNote(currentNote) {
            return new Promise(resolve => {
                editNoteResolve = resolve;
                editNoteInput.value = currentNote;
                editNoteModal.classList.remove('hidden');
                editNoteInput.focus();
            });
        }

        function renderAllCounters(counters) {
            const editModeStates = {};
            if (allCountersData && allCountersData.length > 0) {
                allCountersData.forEach(c => {
                    if (c.isEditingNotes) {
                        editModeStates[c.id] = true;
                    }
                });
            }

            allCountersData = counters;

            allCountersData.forEach(c => {
                if (editModeStates[c.id]) {
                    c.isEditingNotes = true;
                }
            });

            countersWrapper.innerHTML = '';
            countersWrapper.classList.remove('flex', 'items-center', 'justify-center');

            if (!counters || counters.length === 0) {
                 countersWrapper.classList.add('flex', 'items-center', 'justify-center');
                 countersWrapper.innerHTML = '<p class="text-gray-500 text-center">ไม่มีเครื่องนับเลข<br>กดปุ่ม "+" เพื่อเพิ่ม</p>';
                 showDeleteBtn.classList.add('hidden');
                 return;
            }


            showDeleteBtn.classList.toggle('hidden', counters.length <= 1);
            counters.forEach((counterData, index) => {
                const counterElement = counterTemplate.content.cloneNode(true).firstElementChild;
                counterElement.dataset.id = counterData.id;
                
                const titleEl = counterElement.querySelector('.counter-title');
                const countDisplay = counterElement.querySelector('.count-display');
                const notesLog = counterElement.querySelector('.notes-log');
                const notesPanel = counterElement.querySelector('.notes-panel');
                const editNotesBtn = counterElement.querySelector('.edit-notes-btn');
                const doneEditingNotesBtn = counterElement.querySelector('.done-editing-notes-btn');
                const deleteBtn = counterElement.querySelector('.delete-btn');
                const lockBtn = counterElement.querySelector('.lock-step-btn');
                const unlockedIcon = lockBtn.querySelector('.unlocked-icon');
                const lockedIcon = lockBtn.querySelector('.locked-icon');
                const stepInput = counterElement.querySelector('.step-input');

                if (index > 0) {
                    deleteBtn.classList.remove('hidden');
                }

                if (counterData.isStepLocked) {
                    unlockedIcon.classList.add('hidden');
                    lockedIcon.classList.remove('hidden');
                } else {
                    unlockedIcon.classList.remove('hidden');
                    lockedIcon.classList.add('hidden');
                }

                stepInput.value = counterData.stepValue || 1;
                titleEl.textContent = counterData.title;
                countDisplay.textContent = counterData.value;
                
                notesLog.innerHTML = '';
                if (counterData.logs && counterData.logs.length > 0) {
                    counterData.logs.forEach((log, logIndex) => {
                        const logEl = document.createElement('div');
                        logEl.className = 'log-entry p-3 bg-gray-100 rounded-lg border border-gray-200';
                        logEl.dataset.logIndex = logIndex;
                        const date = new Date(log.timestamp).toLocaleString('th-TH');
                        logEl.innerHTML = `<p class="font-normal text-gray-800 whitespace-pre-wrap break-words">${log.note || '<i>ไม่มีโน้ต</i>'}</p><p class="text-xs text-gray-500 mt-1">เมื่อ: ${date}</p>`;
                        notesLog.appendChild(logEl);
                    });
                } else {
                    notesLog.innerHTML = '<p class="text-center text-gray-400">ยังไม่มีประวัติ</p>';
                }

                if (counterData.isEditingNotes) {
                    notesLog.classList.add('edit-mode');
                    notesPanel.classList.add('edit-mode-bg');
                    editNotesBtn.classList.add('hidden');
                    doneEditingNotesBtn.classList.remove('hidden');
                }

                countersWrapper.appendChild(counterElement);
            });
            if (counters.length > 0 && !lastInteractedCounterId) {
                lastInteractedCounterId = counters[0].id;
            }
        }
        
        function handleLogin() {
            const foundUser = testUsers.find(user => user.id === idInput.value.trim() && user.pass === passwordInput.value);
            if (foundUser) {
                currentUser = foundUser;
                localStorage.setItem('loggedInUser', JSON.stringify(foundUser));
                loginModal.classList.add('hidden');
                runApp(); 
            } else {
                authStatus.textContent = 'ไอดีหรือรหัสผ่านไม่ถูกต้อง';
            }
        }

        function exitNoteEditMode(counterInstance) {
            const notesLog = counterInstance.querySelector('.notes-log');
            const notesPanel = counterInstance.querySelector('.notes-panel');
            const editNotesBtn = counterInstance.querySelector('.edit-notes-btn');
            const doneEditingNotesBtn = counterInstance.querySelector('.done-editing-notes-btn');
            const counterId = counterInstance.dataset.id;
            const counterIndex = allCountersData.findIndex(c => c.id === counterId);
            
            if (counterIndex > -1 && allCountersData[counterIndex].isEditingNotes) {
                delete allCountersData[counterIndex].isEditingNotes;
                
                notesLog.classList.remove('edit-mode');
                notesPanel.classList.remove('edit-mode-bg');
                doneEditingNotesBtn.classList.add('hidden');
                editNotesBtn.classList.remove('hidden');
            }
        }

        countersWrapper.addEventListener('click', async (e) => {
            const counterInstance = e.target.closest('.counter-instance');
            if (!counterInstance) return;

            const counterId = counterInstance.dataset.id;
            lastInteractedCounterId = counterId;
            const counterIndex = allCountersData.findIndex(c => c.id === counterId);
            if (counterIndex === -1) return;
            const currentCounter = allCountersData[counterIndex];

            const noteInput = counterInstance.querySelector('.action-note-input');
            const stepInput = counterInstance.querySelector('.step-input');
            const notesLog = counterInstance.querySelector('.notes-log');
            const notesPanel = counterInstance.querySelector('.notes-panel');
            
            const handleUpdate = (newValue, actionDescription) => {
                const userNote = noteInput.value.trim();
                let noteContent = actionDescription;
                if (userNote) {
                    noteContent += `\n${userNote}`;
                }

                const newLog = {
                    value: newValue,
                    note: noteContent,
                    timestamp: new Date().toISOString()
                };
                
                const updatedCounter = { ...currentCounter };
                updatedCounter.value = newValue;
                updatedCounter.logs.unshift(newLog);
                noteInput.value = '';
                if (!updatedCounter.isStepLocked) {
                    updatedCounter.stepValue = 1;
                    stepInput.value = 1;
                }
                
                const newCountersData = allCountersData.map(c => c.id === counterId ? updatedCounter : c);
                saveData(newCountersData);
            };
            
            const updateStepValueFromInput = () => {
                const step = parseInt(stepInput.value) || 1;
                if (currentCounter.stepValue !== step) {
                    currentCounter.stepValue = step;
                }
                return step;
            };

            if (e.target.closest('.increment-btn')) {
                const step = updateStepValueFromInput();
                const newValue = currentCounter.value + step;
                handleUpdate(newValue, `<span class="font-bold text-custom-blue">${newValue}</span> : <span class="font-bold text-green-500">+ ${step}</span>`);
            } else if (e.target.closest('.decrement-btn')) {
                const step = updateStepValueFromInput();
                const newValue = currentCounter.value - step;
                handleUpdate(newValue, `<span class="font-bold text-custom-blue">${newValue}</span> : <span class="font-bold text-red-500">- ${step}</span>`);
            } else if (e.target.closest('.lock-step-btn')) {
                currentCounter.isStepLocked = !currentCounter.isStepLocked;
                saveData([...allCountersData]);
            } else if (e.target.closest('.step-up-btn')) {
                stepInput.stepUp();
                currentCounter.stepValue = parseInt(stepInput.value);
                saveData([...allCountersData]);
            } else if (e.target.closest('.step-down-btn')) {
                stepInput.stepDown();
                currentCounter.stepValue = parseInt(stepInput.value);
                saveData([...allCountersData]);
            } else if (e.target.closest('.reset-btn')) {
                const confirmed = await askForConfirmation(`คุณต้องการรีเซ็ต "${currentCounter.title}" หรือไม่?`);
                if (confirmed) {
                    currentCounter.value = 0;
                    currentCounter.logs = [];
                    currentCounter.isStepLocked = false;
                    currentCounter.stepValue = 1;
                    saveData([...allCountersData]);
                }
            } else if (e.target.closest('.edit-value-btn')) {
                const value = await askForValue(currentCounter.title);
                if (value !== null && value !== '' && !isNaN(value)) {
                    const intValue = parseInt(value, 10);
                    handleUpdate(intValue, `<span class="font-bold text-custom-blue">${intValue}</span> : <b class="font-bold">แก้ไขยอดเป็น ${intValue}</b>`);
                }
            } else if (e.target.closest('.edit-title-btn')) {
                const titleEl = counterInstance.querySelector('.counter-title');
                const input = document.createElement('input');
                input.type = 'text';
                input.value = titleEl.textContent;
                input.className = 'text-3xl font-bold text-gray-800 text-center bg-gray-100 border border-gray-600 rounded-lg w-full';
                
                const saveTitle = () => {
                    const newTitle = input.value.trim();
                    if (newTitle && newTitle !== currentCounter.title) {
                        currentCounter.title = newTitle;
                        saveData([...allCountersData]);
                    } else {
                        input.replaceWith(titleEl);
                    }
                };

                input.addEventListener('blur', saveTitle, { once: true });
                input.addEventListener('keydown', e => {
                    if (e.key === 'Enter') input.blur();
                });
                
                titleEl.replaceWith(input);
                input.focus();
                input.select();
            } else if (e.target.closest('.delete-btn')) {
                const confirmed = await askForConfirmation(`คุณต้องการลบรายการ "${currentCounter.title}" ใช่หรือไม่?`);
                if (confirmed) {
                    const updatedCounters = allCountersData.filter(c => c.id !== counterId);
                    saveData(updatedCounters);
                }
            } else if (e.target.closest('.edit-notes-btn')) {
                currentCounter.isEditingNotes = true;
                notesLog.classList.add('edit-mode');
                notesPanel.classList.add('edit-mode-bg');
                e.target.classList.add('hidden');
                counterInstance.querySelector('.done-editing-notes-btn').classList.remove('hidden');
            } else if (e.target.closest('.done-editing-notes-btn')) {
                exitNoteEditMode(counterInstance);
            } else if (e.target.closest('.log-entry') && notesLog.classList.contains('edit-mode')) {
                const logIndex = parseInt(e.target.closest('.log-entry').dataset.logIndex);
                const originalLog = currentCounter.logs[logIndex];
                
                const noteParts = originalLog.note.split('\n');
                const currentNote = noteParts.length > 1 ? noteParts.slice(1).join('\n') : '';

                const newNoteText = await askToEditNote(currentNote);

                if (newNoteText !== null) {
                    const actionDescription = noteParts[0];
                    let updatedNote = actionDescription;
                    if (newNoteText.trim()) {
                        updatedNote += `\n${newNoteText.trim()}`;
                    }
                    originalLog.note = updatedNote;
                    saveData([...allCountersData]);
                }
            }
        });

        async function runApp() {
            if (unsubscribe) {
                unsubscribe();
                unsubscribe = null;
            }
            
            const savedUser = localStorage.getItem('loggedInUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showLoginBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
                welcomeMessage.innerHTML = `<span class="text-custom-blue">${currentUser.id}</span>`;
                
                userDocRef = doc(db, `artifacts/${appId}/public/data/users/${currentUser.firestoreId}`);
                unsubscribe = onSnapshot(userDocRef, async (docSnap) => {
                    if (docSnap.exists() && docSnap.data().counters) {
                        renderAllCounters(docSnap.data().counters);
                    } else {
                        const defaultCounter = [{ id: `counter-${Date.now()}`, title: 'เครื่องนับเลข', value: 0, logs: [], isStepLocked: false, stepValue: 1 }];
                        await setDoc(userDocRef, { counters: defaultCounter });
                    }
                }, (error) => {
                    console.error("Error with Firestore snapshot: ", error);
                    countersWrapper.innerHTML = `<p class="text-red-500 text-center">เกิดข้อผิดพลาดในการเชื่อมต่อ: ${error.message}</p>`;
                });

            } else {
                currentUser = { id: 'ผู้ใช้ไม่ระบุตัวตน' };
                userDocRef = null;
                
                showLoginBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
                welcomeMessage.innerHTML = '';
                
                const localData = localStorage.getItem('anonymousCounters');
                let counters = localData ? JSON.parse(localData) : [];
                
                if (counters.length === 0) {
                    counters = [{ id: `counter-anon-${Date.now()}`, title: 'เครื่องนับเลข', value: 0, logs: [], isStepLocked: false, stepValue: 1 }];
                    localStorage.setItem('anonymousCounters', JSON.stringify(counters));
                }
                renderAllCounters(counters);
            }
        }

        function setupGlobalListeners() {
            document.addEventListener('click', (e) => {
                const editingCounterData = allCountersData.find(c => c.isEditingNotes);
                if (!editingCounterData) return; 

                const isModalVisible = document.querySelector('#login-modal:not(.hidden), #set-value-modal:not(.hidden), #edit-note-modal:not(.hidden), #delete-modal:not(.hidden), #calculator-modal:not(.hidden), #confirm-modal:not(.hidden)');
                if (isModalVisible) return;

                const calculatorBtn = document.getElementById('calculator-btn');
                if (calculatorBtn.contains(e.target)) {
                    return; 
                }

                const editingCounterInstance = document.querySelector(`.counter-instance[data-id="${editingCounterData.id}"]`);
                if (!editingCounterInstance) return;

                const notesPanel = editingCounterInstance.querySelector('.notes-panel');
                if (!notesPanel.contains(e.target)) {
                    exitNoteEditMode(editingCounterInstance);
                }
            }, true); 

            showLoginBtn.addEventListener('click', () => {
                idInput.value = '';
                passwordInput.value = '';
                authStatus.textContent = '';
                loginModal.classList.remove('hidden');
            });
            closeLoginModalBtn.addEventListener('click', () => loginModal.classList.add('hidden'));
            loginBtn.addEventListener('click', handleLogin);
            passwordInput.addEventListener('keyup', e => e.key === 'Enter' && handleLogin());
            
            togglePasswordBtn.addEventListener('click', () => {
                const isPassword = passwordInput.type === 'password';
                passwordInput.type = isPassword ? 'text' : 'password';
                document.getElementById('eye-open-icon').classList.toggle('hidden', isPassword);
                document.getElementById('eye-closed-icon').classList.toggle('hidden', !isPassword);
            });

            setValueConfirmBtn.addEventListener('click', () => {
                if(setValueResolve) setValueResolve(setValueInputModal.value);
                setValueModal.classList.add('hidden');
            });
            setValueInputModal.addEventListener('keyup', e => e.key === 'Enter' && setValueConfirmBtn.click());
            setValueCancelBtn.addEventListener('click', () => {
                if(setValueResolve) setValueResolve(null);
                setValueModal.classList.add('hidden');
            });
            
            editNoteConfirmBtn.addEventListener('click', () => {
                if(editNoteResolve) editNoteResolve(editNoteInput.value);
                editNoteModal.classList.add('hidden');
            });
            editNoteCancelBtn.addEventListener('click', () => {
                if(editNoteResolve) editNoteResolve(null);
                editNoteModal.classList.add('hidden');
            });
            
            addCounterBtn.addEventListener('click', () => {
                const existingNumbers = allCountersData
                    .map(c => c.title.match(/^เครื่องนับเลข (\d+)$/))
                    .filter(Boolean)
                    .map(match => parseInt(match[1]));
                const maxNumber = existingNumbers.length > 0 ? Math.max(...existingNumbers) : 0;

                const newCounter = {
                    id: `counter-${Date.now()}`,
                    title: `เครื่องนับเลข ${maxNumber + 1}`,
                    value: 0,
                    logs: [],
                    isStepLocked: false,
                    stepValue: 1
                };
                saveData([...allCountersData, newCounter]);
            });

            logoutBtn.addEventListener('click', async () => {
                const confirmed = await askForConfirmation('คุณต้องการออกจากระบบใช่หรือไม่?');
                if(confirmed) {
                    localStorage.removeItem('loggedInUser');
                    runApp(); 
                }
            });

            showDeleteBtn.addEventListener('click', () => {
                deleteListContainer.innerHTML = '';
                allCountersData.slice(1).forEach(counter => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center';
                    div.innerHTML = `<input type="checkbox" id="del-${counter.id}" data-id="${counter.id}" class="mr-2 delete-checkbox"><label for="del-${counter.id}">${counter.title}</label>`;
                    deleteListContainer.appendChild(div);
                });
                selectAllDelete.checked = false;
                deleteModal.classList.remove('hidden');
            });

            deleteCancelBtn.addEventListener('click', () => deleteModal.classList.add('hidden'));
            selectAllDelete.addEventListener('change', (e) => {
                document.querySelectorAll('.delete-checkbox').forEach(cb => cb.checked = e.target.checked);
            });
            deleteConfirmBtn.addEventListener('click', async () => {
                const selectedIds = [...document.querySelectorAll('.delete-checkbox:checked')].map(cb => cb.dataset.id);
                if (selectedIds.length === 0) return;
                
                const confirmed = await askForConfirmation(`คุณต้องการลบ ${selectedIds.length} รายการที่เลือกใช่หรือไม่?`);
                if (confirmed) {
                    const updatedCounters = allCountersData.filter(c => !selectedIds.includes(c.id));
                    saveData(updatedCounters);
                    deleteModal.classList.add('hidden');
                }
            });
            
            // Calculator Logic
            let calcState = { currentInput: '0', expression: [], isResultShown: false };
            function resetCalculator() {
                calcState = { currentInput: '0', expression: [], isResultShown: false };
                updateCalcDisplay();
            }
            function updateCalcDisplay() {
                calcDisplay.textContent = calcState.currentInput;
                calcHistory.textContent = calcState.expression.join(' ') || '\u00A0';
            }
            function handleCalcKeyPress(key) {
                const keyMap = { '/': '÷', '*': '×', 'Enter': '=', 'Escape': 'AC', 'Backspace': 'AC', 'Delete': 'AC' };
                const mappedKey = keyMap[key] || key;
                const button = Array.from(calcKeys.querySelectorAll('button')).find(btn => btn.textContent === mappedKey);
                if (button) button.click();
            }
            calcKeys.addEventListener('click', (event) => {
                const { target } = event;
                if (!target.matches('button')) return;
                const key = target.textContent;
                if (!isNaN(parseFloat(key))) { if (calcState.isResultShown) resetCalculator(); if (calcState.currentInput === '0') { calcState.currentInput = key; } else { calcState.currentInput += key; } } else if (key === '.') { if (calcState.isResultShown) resetCalculator(); if (!calcState.currentInput.includes('.')) { calcState.currentInput += '.'; } } else if (key === 'AC') { resetCalculator(); } else if (key === '+/-') { calcState.currentInput = (parseFloat(calcState.currentInput) * -1).toString(); } else if (key === '%') { calcState.currentInput = (parseFloat(calcState.currentInput) / 100).toString(); } else if (['+', '-', '×', '÷'].includes(key)) { if(calcState.currentInput === 'Error') return; if (calcState.isResultShown) { calcState.expression = [calcState.currentInput]; calcState.isResultShown = false; } else { calcState.expression.push(calcState.currentInput); } calcState.expression.push(key); calcState.currentInput = '0'; } else if (key === '=') { if (calcState.expression.length < 2) return; calcState.expression.push(calcState.currentInput); try { const evalStr = calcState.expression.join('').replace(/×/g, '*').replace(/÷/g, '/'); const result = eval(evalStr); calcState.currentInput = `${parseFloat(result.toFixed(7))}`; calcState.isResultShown = true; } catch (e) { calcState.currentInput = 'Error'; calcState.expression = []; } }
                updateCalcDisplay();
            });
            calculatorBtn.addEventListener('click', () => { calculatorModal.classList.remove('hidden'); });
            calculatorModal.addEventListener('click', (event) => { if (event.target === calculatorModal) { calculatorModal.classList.add('hidden'); resetCalculator(); } });
            
            // Keyboard shortcuts
            window.addEventListener('keydown', (e) => {
                const activeEl = document.activeElement;
                const isTyping = ['INPUT', 'TEXTAREA'].includes(activeEl.tagName);
                if (!calculatorModal.classList.contains('hidden')) { handleCalcKeyPress(e.key); return; }
                if (isTyping) return;
                if ([loginModal, setValueModal, deleteModal, confirmModal, editNoteModal].some(modal => !modal.classList.contains('hidden'))) return;
                if (e.key === 'Delete') { e.preventDefault(); const counterEl = document.querySelector(`[data-id="${lastInteractedCounterId}"]`); if(counterEl && allCountersData.findIndex(c => c.id === lastInteractedCounterId) > 0) { counterEl.querySelector('.delete-btn').click(); } } else if (e.key === 'Escape') { e.preventDefault(); const counterEl = document.querySelector(`[data-id="${lastInteractedCounterId}"]`); if(counterEl) counterEl.querySelector('.reset-btn').click(); } else if (e.ctrlKey && e.shiftKey) { e.preventDefault(); const counterEl = document.querySelector(`[data-id="${lastInteractedCounterId}"]`); if(counterEl) counterEl.querySelector('.edit-value-btn').click(); }
            });
        }

        // --- จุดเริ่มต้นของแอป ---
        async function main() {
            try {
                const initialToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (initialToken) {
                    await signInWithCustomToken(auth, initialToken);
                } else {
                    await signInAnonymously(auth);
                }
                console.log("Firebase Authentication successful.");

                setupGlobalListeners();
                runApp();

            } catch (error) {
                console.error("Critical Error: Could not sign in to Firebase.", error);
                countersWrapper.innerHTML = `<p class="text-red-500 text-center">เกิดข้อผิดพลาดในการเชื่อมต่อกับเซิร์ฟเวอร์: ${error.message}<br>โปรดลองรีเฟรชหน้าเว็บ</p>`;
            }
        }

        main();

    </script>
</body>
</html>
